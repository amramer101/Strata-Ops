def COLOR_MAP = [
    'SUCCESS': 'good', 
    'FAILURE': 'danger',
]

pipeline {   
    agent any

    tools {
        jdk "JDK21"
        maven "Maven3.9"
    }

    environment {
        NEXUS_VERSION       = "nexus3"
        NEXUS_USER          = "admin"
        NEXUS_PASS          = "admin123" 
        NEXUSIP             = "nexus.eprofile.in"
        NEXUSPORT           = "8081"
        NEXUS_REPOSITORY    = "vprofile-repo" // غيرتها لاسم الريبو اللي إنت هتكريته جوه نيكسوس
        NEXUS_CREDENTIAL_ID = "nexuslogin" 
        ARTVERSION          = "${env.BUILD_ID}"
        
        SONARSERVER         = "sonarserver" 
        SONARSCANNER        = "sonarscanner" 
        
        TOMCAT_IP           = "tomcat.eprofile.in"
        TOMCAT_USER         = "ubuntu"
    }

    stages {
        stage("Test") {
            steps {
                sh "mvn test"
            }
        }

        stage("Checkstyle Analysis") {
            steps {
                sh "mvn checkstyle:checkstyle"
            }
        } 

        stage('Sonar Analysis') {
            environment {
                scannerHome = tool "${SONARSCANNER}"
            }
            steps {
               withSonarQubeEnv("${SONARSERVER}") {
                   sh '''${scannerHome}/bin/sonar-scanner \
                   -Dsonar.projectKey=vprofile \
                   -Dsonar.projectName=vprofile \
                   -Dsonar.projectVersion=1.0 \
                   -Dsonar.sources=src/ \
                   -Dsonar.java.binaries=target/test-classes/com/visualpathit/account/controllerTest/ \
                   -Dsonar.junit.reportsPath=target/surefire-reports/ \
                   -Dsonar.jacoco.reportsPath=target/jacoco.exec \
                   -Dsonar.java.checkstyle.reportPaths=target/checkstyle-result.xml'''
              }
            }
        }

        stage("Quality Gate") {
            steps {
                timeout(time: 1, unit: 'HOURS') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage("Package & Archive Artifacts") {
            steps {
                sh "mvn -DskipTests package"
            }
            post {
                success {
                    echo "Archiving Artifacts .." 
                    archiveArtifacts artifacts: '**/*.war'
                }
            }
        }

        stage("Upload Artifact to Nexus") {
            steps {
                nexusArtifactUploader(
                  nexusVersion: "${NEXUS_VERSION}",
                  protocol: 'http',
                  nexusUrl: "${NEXUSIP}:${NEXUSPORT}",
                  groupId: 'QA',
                  version: "${env.BUILD_ID}-${env.BUILD_TIMESTAMP}",
                  repository: "${NEXUS_REPOSITORY}",
                  credentialsId: "${NEXUS_CREDENTIAL_ID}",
                  artifacts: [
                    [artifactId: 'vproapp',
                     classifier: '',
                     file: 'target/vprofile-v2.war',
                     type: 'war']
                  ]
                )
            }
        }

        // ========================================================
        // Push Model Deployment to Tomcat
        // ========================================================
        stage('Deploy to Tomcat (Push)') {
            steps {
                sshagent(['tomcat-ssh-key']) {
                    sh """
                    echo "Deploying Artifact to Tomcat Server..."
                    
                    scp -o StrictHostKeyChecking=no target/vprofile-v2.war ${TOMCAT_USER}@${TOMCAT_IP}:/tmp/vprofile-v2.war
                    
                    ssh -o StrictHostKeyChecking=no ${TOMCAT_USER}@${TOMCAT_IP} '
                        echo "Stopping Tomcat..."
                        sudo systemctl stop tomcat10
                        
                        echo "Cleaning old files..."
                        sudo rm -rf /var/lib/tomcat10/webapps/ROOT*
                        
                        echo "Deploying new WAR as ROOT..."
                        sudo cp /tmp/vprofile-v2.war /var/lib/tomcat10/webapps/ROOT.war
                        sudo chown tomcat:tomcat /var/lib/tomcat10/webapps/ROOT.war
                        
                        echo "Starting Tomcat..."
                        sudo systemctl start tomcat10
                        echo "Deployment Successful!"
                    '
                    """
                }
            }
        }
    }

    post {
        always {
            echo 'Sending Slack Notifications...'
            slackSend channel: '#jenkins-cicd',
                color: COLOR_MAP[currentBuild.currentResult],
                message: "*${currentBuild.currentResult}:* Job ${env.JOB_NAME} build ${env.BUILD_NUMBER} \n More info at: ${env.BUILD_URL}"
        }
    }
}